# Mahjong Discord Bot

このDiscordボットは、麻雀のスコアを自動集計する機能を提供します。天鳳や雀魂などのオンライン麻雀ゲームでのスコア集計を効率化することを目的としています。

## 機能概要

以下のスラッシュコマンドを使用して、麻雀のスコア集計を行うことができます。

### 1. ゲームセットを開始する

`/mj_start`

このコマンドを実行すると、新しい麻雀のスコア集計セッションが開始されます。
すでに進行中のゲームセットがある場合は、確認メッセージが表示され、既存のゲームセットを破棄して新しいゲームセットを開始するかを選択できます。

### 2. 1ゲームの結果を記録する

`/mj_record [service] [rule] [players] [scores]`

1ゲームが終了するごとに、このコマンドを使用して結果を記録します。

*   **`service`**: プレイした麻雀サービスを選択します。
    *   `jantama`: 雀魂
    *   `tenhou`: 天鳳
*   **`rule`**: ゲームのルールを選択します。
    *   `tonpu`: 東風戦
    *   `hanchan`: 半荘戦
*   **`players`**: 参加人数を選択します。
    *   `3`: 3人麻雀 (サンマ)
    *   `4`: 4人麻雀
*   **`scores`**: プレイヤー名とスコアのペアをカンマ区切りで入力します。
    *   例: `player1:25000,player2:15000,player3:-10000,player4:-30000`
    *   プレイヤー名はDiscordのユーザー名やニックネームが推奨されます。ボットがサーバー内のメンバーを検索し、自動的にメンションに変換します。
    *   スコアは整数値で入力してください。

**バリデーション:**
*   スコアの合計が0 (ゼロサムゲーム) であるかチェックされます。
*   指定された人数と入力されたスコアの数が一致するかチェックされます。
*   プレイヤー名が重複していないかチェックされます。
*   スコアの形式 (`名前:スコア`) が正しいかチェックされます。

### 3. 現在のスコアを確認する

`/mj_scores`

このコマンドを実行すると、現在のゲームセットにおける各プレイヤーのトータルスコアと順位が表示されます。

### 4. ゲームセットを完了する

`/mj_end`

このコマンドを実行すると、現在のゲームセットが終了し、それまでに記録された全ゲームのトータルスコアがプレイヤーごとに集計され、降順で表示されます。
集計完了後、スコアデータは `gamesets.{タイムスタンプ}.json` というファイル名で保存され、新しい集計を開始できる状態になります。

## 実行方法

### 1. Discord Bot Token の設定

Discord開発者ポータルでボットを作成し、トークンを取得してください。取得したトークンを環境変数 `DISCORD_BOT_TOKEN` に設定します。

```bash
export DISCORD_BOT_TOKEN="YOUR_BOT_TOKEN_HERE"
```

### 2. 依存関係のインストール

プロジェクトは [Poetry](https://python-poetry.org/) で管理されています。以下のコマンドで依存関係をインストールしてください。

```bash
poetry install
```

### 3. ボットの起動

以下のコマンドでボットを起動します。

```bash
poetry run python app/main.py
```

ボットが起動すると、Discordサーバーに接続され、スラッシュコマンドが利用可能になります。

## 開発について

### コード品質ツール

このプロジェクトでは、以下のコード品質ツールが導入されています。変更を加える際は、これらのツールでコードを点検・整形してください。

*   `ruff`: コードの整形と静的解析
*   `isort`: インポートのソート
*   `black`: コードフォーマッター
*   `mypy`: 型チェック

以下のコマンドで実行できます。

```bash
poetry run ruff check . --fix && poetry run isort . && poetry run black .
poetry run mypy .
```

### テスト

単体テストには `pytest` と `pytest-cov` を使用しています。コードカバレッジ100%を目指しています。

以下のコマンドでテストを実行できます。

```bash
poetry run pytest
```

## データの永続化

*   進行中のゲームセットのデータは、プロジェクトルートの `gamesets.json` ファイルにリアルタイムで保存されます。
*   `/mj_end` コマンドが実行されると、その時点の `gamesets.json` は `gamesets.YYYYMMDDHHMMSS.json` のようなタイムスタンプ付きのファイル名に変更され、アーカイブされます。その後、新しい `gamesets.json` が空の状態で作成されます。
