# Mahjong Discord Bot

このDiscordボットは、麻雀のスコアを自動集計する機能を提供します。天鳳や雀魂などのオンライン麻雀ゲームでのスコア集計を効率化することを目的としています。

## 機能概要

以下のスラッシュコマンドを使用して、麻雀のスコア集計を行うことができます。

### 1. ゲームセットを開始する

`/start_gameset`

このコマンドを実行すると、新しい麻雀のスコア集計セッションが開始されます。
すでに進行中のゲームセットがある場合は、その旨が通知されます。

### 2. 1ゲームの結果を記録する

`/record_game [rule] [players] [scores]`

1ゲームが終了するごとに、このコマンドを使用して結果を記録します。

*   **`rule`**: ゲームのルールを指定します。
    *   `tonpu`: 東風戦
    *   `hanchan`: 半荘戦
*   **`players`**: 参加人数を指定します。
    *   `sanma`: サンマ (3人)
    *   `yonma`: 4人麻雀 (4人)
*   **`scores`**: プレイヤー名とスコアのペアをカンマ区切りで入力します。
    *   例: `@player1:25000,@player2:15000,@player3:-10000,@player4:-30000`
    *   プレイヤー名はDiscordのメンション形式 (`@ユーザー名`) が推奨されますが、任意の文字列も受け付けます。
    *   スコアは整数値で入力してください。

**バリデーション:**
*   スコアの合計が0 (ゼロサムゲーム) であるかチェックされます。合計が0でない場合、再入力を求められます。
*   指定された人数 (`sanma` なら3人、`yonma` なら4人) と入力されたスコアの数が一致するかチェックされます。不足がある場合、再入力を求められます。
*   スコアの形式 (`名前:スコア`) が正しいかチェックされます。

### 3. ゲームセットを完了する

`/end_gameset`

このコマンドを実行すると、現在のゲームセットが終了し、それまでに記録された全ゲームのトータルスコアがプレイヤーごとに集計され、降順で表示されます。

## 実行方法

### 1. Discord Bot Token の設定

Discord開発者ポータルでボットを作成し、トークンを取得してください。取得したトークンを環境変数 `DISCORD_BOT_TOKEN` に設定します。

```bash
export DISCORD_BOT_TOKEN="YOUR_BOT_TOKEN_HERE"
```

### 2. 依存関係のインストール

プロジェクトは [Poetry](https://python-poetry.org/) で管理されています。以下のコマンドで依存関係をインストールしてください。

```bash
poetry install
```

### 3. ボットの起動

以下のコマンドでボットを起動します。

```bash
poetry run python app/main.py
```

ボットが起動すると、Discordサーバーに接続され、スラッシュコマンドが利用可能になります。

## 開発について

### コード品質ツール

このプロジェクトでは、以下のコード品質ツールが導入されています。変更を加える際は、これらのツールでコードを点検・整形してください。

*   `ruff`: コードの整形と静的解析
*   `isort`: インポートのソート
*   `black`: コードフォーマッター
*   `mypy`: 型チェック

以下のコマンドで実行できます。

```bash
poetry run ruff check app/main.py --fix && poetry run isort app/main.py && poetry run black app/main.py
poetry run mypy app/main.py
```

### テスト

単体テストには `pytest` と `pytest-cov` を使用しています。コードカバレッジ100%を目指しています。

以下のコマンドでテストを実行できます。

```bash
poetry run pytest --cov=app --cov-report=term-missing tests/test_main.py
```

### データの永続化

ローカル環境では `gamesets.json` ファイルにスコアデータが保存されます。将来的にGoogle Cloudでのホスティングを考慮した設計になっています。
